# Comic Book Translator

Translate Chinese text bubbles from comic books to English using the Anthropic API. Provides detailed linguistic breakdowns including sentence-by-sentence translations, vocabulary with Jyutping romanization, and grammar points.

## Features

- Translates Traditional Chinese to English
- Sentence-by-sentence breakdown
- Vocabulary extraction with:
  - Traditional Chinese characters
  - Contextual English meanings
  - Jyutping romanization
- Grammar point identification
- Automatic Chinese text detection
- Preserves bounding box information for integration with comic reader

## Prerequisites

- [Bun](https://bun.sh/) runtime installed
- Anthropic API key

## Setup

1. **Install dependencies:**
   ```bash
   cd translator
   bun install
   ```

2. **Configure API key:**

   Create a `.env` file in the project root (not the translator directory):
   ```bash
   cd ..  # Go to project root
   cp .env.example .env
   ```

   Edit `.env` and add your Anthropic API key:
   ```
   ANTHROPIC_API_KEY=sk-ant-api03-your-actual-key-here
   ```

## Usage

### Single File Translation

Translate a single OCR JSON file:

```bash
cd translator
bun run src/index.ts --input ../assets/pizarro/page1-ocr.json
```

This will create `../assets/pizarro/page1-translation.json`.

### With Album Context

Include the comic album/series name for better context:

```bash
bun run src/index.ts --input ../assets/pizarro/page1-ocr.json --album "Tintin and the Picaros" 
```

### Custom Output Path

Specify a custom output location:

```bash
bun run src/index.ts \
  --input ../assets/pizarro/page1-ocr.json \
  --output ../assets/pizarro/translations/page1.json \
  --album "Tintin and the Picaros"
```

### Batch Processing

From the project root, process all pages in a comic:

```bash
cd ..  # Go to project root
bun run translate
```

This processes all `*-ocr.json` files in `assets/pizarro/`.

## Command-Line Options

```
Options:
  -i, --input <file>     Path to OCR JSON file (required)
  -o, --output <file>    Output path (default: <input>-translation.json)
  -a, --album <name>     Comic album/series name (optional)
  -m, --model <model>    Anthropic model to use (default: claude-sonnet-4-5-20250929)
  -h, --help             Show help message
```

## Input Format

The tool expects OCR JSON files generated by the `ocr` tool with this structure:

```json
{
  "image_info": {
    "path": "../assets/pizarro/page1.avif",
    "width": 3024,
    "height": 4032
  },
  "detections": [
    {
      "label": "text_bubble",
      "bbox": { "x1": 1179.53, "y1": 1997.75, "x2": 1919.11, "y2": 2300.9 },
      "ocr_result": {
        "full_text": "狂妄到連首都都按他的名字重\n新命名為...",
        "avg_confidence": 0.9909
      }
    }
  ]
}
```

## Output Format

Generates translation JSON files with detailed linguistic analysis:

```json
{
  "image_info": {
    "path": "../assets/pizarro/page1.avif",
    "width": 3024,
    "height": 4032
  },
  "translations": [
    {
      "bbox": { "x1": 1179.53, "y1": 1997.75, "x2": 1919.11, "y2": 2300.9 },
      "original_text": "狂妄到連首都都按他的名字重新命名為...",
      "translation_result": {
        "chinese_text": "狂妄到連首都都按他的名字重新命名為...",
        "translation": "So arrogant that he even renamed the capital...",
        "sentences": [
          {
            "chinese_text": "狂妄到連首都都按他的名字重新命名為\"塔比奥卡波利斯\"。",
            "english_translation": "So arrogant that he renamed the capital...",
            "vocabulary": [
              {
                "word": "狂妄",
                "translation": "arrogant, presumptuous",
                "romanization": "kwong4 mong5"
              }
            ],
            "grammar_points": [
              {
                "pattern": "到連...都...",
                "explanation": "so... that even...",
                "example": "狂妄到連首都都按他的名字重新命名"
              }
            ]
          }
        ]
      },
      "api_metadata": {
        "model": "claude-sonnet-4-5-20250929",
        "tokens_used": { "input": 450, "output": 380 }
      }
    }
  ],
  "metadata": {
    "source_ocr_file": "page1-ocr.json",
    "processed_at": "2025-12-17T10:30:00Z",
    "total_bubbles": 12,
    "translated_bubbles": 10,
    "skipped_bubbles": 2,
    "total_tokens": 8340
  }
}
```

## How It Works

1. **Load OCR Results**: Reads the OCR JSON file containing detected text bubbles
2. **Validate Text**: Checks each bubble for Chinese characters
3. **Translate**: Calls Anthropic API with a structured prompt requesting:
   - Full translation
   - Sentence breakdown
   - Vocabulary with Jyutping romanization
   - Grammar points
4. **Parse Response**: Extracts JSON from API response (handles markdown wrapping)
5. **Save Results**: Writes translation data with bounding boxes to output file

## Error Handling

The tool gracefully handles:
- **Missing Chinese text**: Skips bubbles without Chinese characters
- **API errors**: Retries with exponential backoff (up to 3 attempts)
- **Rate limits**: Adds delays between requests (1 second per bubble)
- **Network failures**: Automatic retry with backoff

## Cost Estimation

Typical costs per page (10-15 bubbles):
- Input tokens: ~5,000 tokens × $3/million = $0.015
- Output tokens: ~3,000 tokens × $15/million = $0.045
- **Total: ~$0.06 per page**

The tool displays actual token usage and estimated cost after completion.

## Troubleshooting

### API Key Not Found

```
Error: ANTHROPIC_API_KEY environment variable not set
```

**Solution**: Create a `.env` file in the project root with your API key.

### No Chinese Text Detected

```
⚠️  Skipping: No Chinese characters detected
```

**Solution**: This is normal for bubbles with only English text or symbols. They're automatically skipped.

### Rate Limit Errors

```
API error (429), retrying in 2000ms...
```

**Solution**: The tool automatically retries. If persistent, consider adding longer delays between files in batch mode.

## Development

### Project Structure

```
translator/
├── src/
│   ├── index.ts       # CLI entry point
│   ├── translate.ts   # Translation orchestrator
│   ├── anthropic.ts   # API client
│   ├── validators.ts  # Chinese text detection
│   └── types.ts       # TypeScript interfaces
├── package.json
├── tsconfig.json
└── README.md
```

### Running from Source

```bash
cd translator
bun run src/index.ts --help
```
